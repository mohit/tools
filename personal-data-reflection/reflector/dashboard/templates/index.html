<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Data Reflection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #86868b;
            font-size: 1.1em;
        }

        .nav {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .nav button {
            padding: 10px 20px;
            border: none;
            background: #0071e3;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background 0.2s;
        }

        .nav button:hover {
            background: #0077ed;
        }

        .nav button.active {
            background: #1d1d1f;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-label {
            color: #86868b;
            font-size: 0.9em;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 600;
            color: #1d1d1f;
        }

        .stat-change {
            font-size: 0.85em;
            margin-top: 5px;
        }

        .stat-change.positive {
            color: #28a745;
        }

        .stat-change.negative {
            color: #dc3545;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .section h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .insight-grid {
            display: grid;
            gap: 15px;
        }

        .insight-card {
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0071e3;
        }

        .insight-card.highlight {
            background: #e8f5e9;
            border-left-color: #28a745;
        }

        .insight-card.lowlight {
            background: #ffebee;
            border-left-color: #dc3545;
        }

        .insight-card.pattern {
            background: #e3f2fd;
            border-left-color: #0071e3;
        }

        .insight-card.recommendation {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .insight-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .insight-description {
            color: #424245;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #86868b;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: 1px solid #d2d2d7;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            color: #1d1d1f;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #f5f5f7;
            border-color: #86868b;
        }

        .month-selector select {
            padding: 8px 15px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 1em;
            background: white;
        }

        /* Calendar Styles */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .period-selector {
            display: flex;
            gap: 5px;
            background: #f5f5f7;
            padding: 4px;
            border-radius: 8px;
        }

        .period-selector button {
            padding: 6px 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            color: #424245;
        }

        .period-selector button.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            color: #1d1d1f;
            font-weight: 500;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 30px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #86868b;
            padding: 10px 0;
            font-size: 0.9em;
        }

        .calendar-cell {
            background: white;
            border-radius: 8px;
            min-height: 100px;
            padding: 10px;
            position: relative;
            transition: transform 0.2s;
            border: 1px solid transparent;
        }

        .calendar-cell:hover {
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .calendar-cell.empty {
            background: transparent;
            box-shadow: none;
            pointer-events: none;
        }

        .cell-date {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 5px;
            color: #1d1d1f;
        }

        .cell-metric {
            font-size: 0.8em;
            color: #424245;
            margin-bottom: 2px;
        }

        .workout-dot {
            height: 6px;
            width: 6px;
            background-color: #ff3b30;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        /* Intensity Colors based on steps */
        .intensity-0 {
            border-color: #f5f5f7;
        }

        .intensity-1 {
            background-color: #e3f2fd;
            border-color: #bbdefb;
        }

        /* < 5k */
        .intensity-2 {
            background-color: #c8e6c9;
            border-color: #a5d6a7;
        }

        /* 5k-10k */
        .intensity-3 {
            background-color: #81c784;
            border-color: #66bb6a;
        }

        /* 10k-15k */
        .intensity-4 {
            background-color: #4caf50;
            border-color: #43a047;
            color: white !important;
        }

        /* > 15k */
        .intensity-4 .cell-date,
        .intensity-4 .cell-metric {
            color: white;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .summary-label {
            font-size: 0.8em;
            text-transform: uppercase;
            color: #86868b;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 1.4em;
            font-weight: 600;
        }

        .summary-comparison {
            font-size: 0.8em;
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Personal Data Reflection</h1>
            <p class="subtitle">Your monthly health and fitness insights</p>
            <div class="nav">
                <button class="active" onclick="showView('overview')">Overview</button>
                <button onclick="showView('calendar')">Calendar</button>
                <button onclick="showView('insights')">Insights</button>
                <button onclick="showView('patterns')">Patterns</button>
                <button onclick="showView('correlations')">Correlations</button>
            </div>
        </header>

        <div id="content">
            <div class="loading">Loading your data...</div>
        </div>
    </div>

    <script>
        let currentView = 'overview';
        let currentData = null;
        let calendarState = {
            date: new Date(),
            summaryPeriod: 'month' // week, month, quarter, year
        };

        async function loadOverview() {
            try {
                const response = await fetch('/api/overview');
                const data = await response.json();

                if (!data.has_data) {
                    document.getElementById('content').innerHTML = `
                        <div class="error">
                            <h3>No Data Found</h3>
                            <p>Import your Apple Health or Strava data to get started.</p>
                            <p>Run: <code>python reflect.py import-health /path/to/data</code></p>
                        </div>
                    `;
                    return;
                }

                currentData = data;
                renderOverview(data);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">Error loading data: ${error.message}</div>
                `;
            }
        }

        function renderOverview(data) {
            const current = data.current_month.stats;
            const previous = data.previous_month.stats;

            const calcChange = (curr, prev) => {
                if (!prev || prev === 0) return null;
                return ((curr - prev) / prev * 100).toFixed(0);
            };

            const html = `
                <div class="stats-grid">
                    ${renderStatCard('Total Steps', current.total_steps.toLocaleString(), calcChange(current.total_steps, previous.total_steps), 'steps')}
                    ${renderStatCard('Avg Steps/Day', Math.round(current.avg_steps).toLocaleString(), calcChange(current.avg_steps, previous.avg_steps), 'avg_steps')}
                    ${renderStatCard('Workouts', current.workout_count, calcChange(current.workout_count, previous.workout_count), 'workouts')}
                    ${renderStatCard('Avg Sleep', current.avg_sleep_hours > 0 ? current.avg_sleep_hours.toFixed(1) + ' hrs' : '<span style="color:#999;font-size:0.6em">No Data</span>', calcChange(current.avg_sleep_hours, previous.avg_sleep_hours), 'sleep')}
                    ${renderStatCard('Total Distance', current.total_distance_km.toFixed(1) + ' km', calcChange(current.total_distance_km, previous.total_distance_km), 'distance')}
                    ${renderStatCard('Active Energy', Math.round(current.total_active_energy).toLocaleString() + ' kcal', calcChange(current.total_active_energy, previous.total_active_energy), 'energy')}
                </div>

                <div class="section">
                    <h2>Data Range</h2>
                    <p>Tracking data from <strong>${data.date_range.start}</strong> to <strong>${data.date_range.end}</strong></p>
                    <p style="margin-top: 10px; color: #86868b;">
                        Showing data for ${data.current_month.year}-${String(data.current_month.month).padStart(2, '0')}
                    </p>
                </div>
            `;

            document.getElementById('content').innerHTML = html;
        }

        function renderStatCard(label, value, change, type) {
            let changeHtml = '';
            if (change !== null) {
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeSymbol = change >= 0 ? '‚ñ≤' : '‚ñº';
                changeHtml = `<div class="stat-change ${changeClass}">${changeSymbol} ${Math.abs(change)}% <span style="color:#86868b; font-weight:normal;">vs last month</span></div>`;
            }

            // Icons
            const icons = {
                steps: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0071e3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 16v-2.38C4 11.5 5.9 9.8 8.1 9.8s4.1 1.7 4.1 3.82c0 2.22 1.8 3.82 4.1 3.82s4.1-1.6 4.1-3.82V8"/></svg>',
                avg_steps: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0071e3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
                workouts: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>',
                sleep: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#5856d6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
                distance: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#34c759" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>',
                energy: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff9500" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>'
            };

            return `
                <div class="stat-card">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div class="stat-label">${label}</div>
                        <div style="opacity:0.8">${icons[type] || ''}</div>
                    </div>
                    <div class="stat-value">${value}</div>
                    ${changeHtml}
                </div>
            `;
        }

        // Helper date formatter
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const options = { month: 'short', day: 'numeric' };
            // Append timezone offset to ensure correct local date
            const date = new Date(dateStr + 'T12:00:00');
            return date.toLocaleDateString('en-US', options);
        }

        async function loadInsights() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;

            try {
                const response = await fetch(`/api/insights/${year}/${month}`);
                const insights = await response.json();
                renderInsights(insights);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">Error loading insights: ${error.message}</div>
                `;
            }
        }

        function renderInsights(insights) {
            const html = `
                ${renderInsightSection('Highlights', insights.highlights, 'highlight')}
                ${renderInsightSection('Areas to Improve', insights.lowlights, 'lowlight')}
                ${renderInsightSection('Patterns Discovered', insights.patterns, 'pattern')}
                ${renderInsightSection('Recommendations', insights.recommendations, 'recommendation')}
            `;

            document.getElementById('content').innerHTML = html;
        }

        function renderInsightSection(title, items, type) {
            if (!items || items.length === 0) {
                return '';
            }

            const itemsHtml = items.map(item => `
                <div class="insight-card ${type}">
                    <div class="insight-title">${item.title}</div>
                    <div class="insight-description">${item.description}</div>
                </div>
            `).join('');

            return `
                <div class="section">
                    <h2>${title}</h2>
                    <div class="insight-grid">
                        ${itemsHtml}
                    </div>
                </div>
            `;
        }

        async function loadPatterns() {
            const now = new Date();
            const endDate = now.toISOString().split('T')[0];
            const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

            try {
                const response = await fetch(`/api/patterns/${startDate}/${endDate}`);
                const patterns = await response.json();
                renderPatterns(patterns);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">Error loading patterns: ${error.message}</div>
                `;
            }
        }

        function renderPatterns(patterns) {
            const html = `
                <div class="section">
                    <h2 style="margin-bottom:10px">Good Days Analysis</h2>
                    <div style="display:flex; gap:20px; align-items:center; margin-bottom:20px; background:#f9f9f9; padding:15px; border-radius:8px;">
                        <div style="flex:1">
                            <div style="font-weight:600; margin-bottom:5px;">Daily Goals</div>
                            <div style="display:flex; gap:15px; font-size:0.9em; color:#555;">
                                <div title="Steps Goal"><span style="color:#0071e3">üëü</span> ${patterns.goals.min_steps.toLocaleString()}+ steps</div>
                                <div title="Exercise Goal"><span style="color:#ff3b30">üî•</span> ${patterns.goals.min_exercise}m+ exercise</div>
                                <div title="Sleep Goal" style="opacity:${patterns.goals.min_sleep > 0 ? 1 : 0.5}"><span style="color:#5856d6">üõå</span> ${patterns.goals.min_sleep}h+ sleep</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:2em; font-weight:700; line-height:1;">${patterns.good_days.length}</div>
                            <div style="font-size:0.8em; color:#888;">GOOD DAYS</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Day of Week Patterns</h2>
                    ${renderDayOfWeekTable(patterns.day_of_week)}
                </div>

                <div class="section">
                    <h2>Workout Patterns</h2>
                    ${renderWorkoutPatterns(patterns.workouts)}
                </div>

                ${patterns.step_streaks.length > 0 ? `
                <div class="section">
                    <h2>Step Streaks</h2>
                    <p>Longest streak: <strong>${patterns.step_streaks[0].length_days}</strong> days <span style="color:#888;font-size:0.9em">(${formatDate(patterns.step_streaks[0].start_date)} - ${formatDate(patterns.step_streaks[0].end_date)})</span></p>
                </div>
                ` : ''}
            `;

            document.getElementById('content').innerHTML = html;
        }

        function renderDayOfWeekTable(dayOfWeek) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f5f5f7;"><th style="padding: 12px; text-align: left;">Day</th><th style="padding: 12px; text-align: right;">Avg Steps</th><th style="padding: 12px; text-align: right;">Avg Sleep</th><th style="padding: 12px; text-align: right;">Avg Exercise</th></tr></thead><tbody>';

            for (const [day, data] of Object.entries(dayOfWeek)) {
                html += `
                    <tr style="border-bottom: 1px solid #e5e5e7;">
                        <td style="padding: 12px;">${day}</td>
                        <td style="padding: 12px; text-align: right;">${data.avg_steps.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: right;">${data.avg_sleep}h</td>
                        <td style="padding: 12px; text-align: right;">${data.avg_exercise}m</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            return html;
        }

        function renderWorkoutPatterns(workouts) {
            if (!workouts.workout_types || workouts.workout_types.length === 0) {
                return '<p>No workout data available.</p>';
            }

            let html = '<h3>Workout Types</h3><ul style="list-style: none; padding: 0;">';
            workouts.workout_types.forEach(type => {
                html += `<li style="padding: 8px 0; border-bottom: 1px solid #e5e5e7;">
                    <strong>${type.type}</strong>: ${type.count} times, avg ${type.avg_duration}min
                </li>`;
            });
            html += '</ul>';

            return html;
        }

        async function loadCorrelations() {
            const now = new Date();
            const endDate = now.toISOString().split('T')[0];
            const startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

            try {
                const response = await fetch(`/api/correlations/${startDate}/${endDate}`);
                const correlations = await response.json();
                renderCorrelations(correlations);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">Error loading correlations: ${error.message}</div>
                `;
            }
        }

        // Calendar Functions
        async function loadCalendar() {
            const dateStr = calendarState.date.toISOString().split('T')[0];

            // 1. Load Summary Data
            try {
                const summaryRes = await fetch(`/api/summary?period=${calendarState.summaryPeriod}&date=${dateStr}`);
                const summaryData = await summaryRes.json();

                // 2. Load Calendar Grid Data (always load full month of current view)
                // Calculate start/end for the grid view
                const year = calendarState.date.getFullYear();
                const month = calendarState.date.getMonth();
                const startOfMonth = new Date(year, month, 1);
                const endOfMonth = new Date(year, month + 1, 0);

                const gridRes = await fetch(`/api/daily/${startOfMonth.toISOString().split('T')[0]}/${endOfMonth.toISOString().split('T')[0]}`);
                const gridData = await gridRes.json();

                renderCalendarView(summaryData, gridData);
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="error">Error loading calendar: ${error.message}</div>
                `;
            }
        }

        function updateCalendarPeriod(period) {
            calendarState.summaryPeriod = period;
            loadCalendar();
        }

        function changeCalendarDate(months) {
            calendarState.date.setMonth(calendarState.date.getMonth() + months);
            loadCalendar();
        }

        function renderCalendarView(summary, grid) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const viewDate = calendarState.date;

            // --- Summary Section ---
            const cur = summary.current.stats;
            const prev = summary.previous.stats;
            const calcDiff = (c, p) => p ? Math.round(((c - p) / p) * 100) : null;

            const renderDiff = (diff) => {
                if (diff === null) return '<span style="color:#999">-</span>';
                const color = diff >= 0 ? '#28a745' : '#dc3545';
                const arrow = diff >= 0 ? '‚ñ≤' : '‚ñº';
                return `<span style="color:${color}">${arrow} ${Math.abs(diff)}%</span> vs prev`;
            };

            const summaryHtml = `
                <div class="section" style="padding: 20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h2 style="margin:0; font-size:1.4em;">Performance Summary</h2>
                        <div class="period-selector">
                            ${['week', 'month', 'quarter', 'year'].map(p =>
                `<button class="${calendarState.summaryPeriod === p ? 'active' : ''}" onclick="updateCalendarPeriod('${p}')">${p.charAt(0).toUpperCase() + p.slice(1)}</button>`
            ).join('')}
                        </div>
                    </div>
                    <div style="font-size:0.9em; color:#666; margin-bottom:15px;">
                        Comparing ${summary.current.start_date} - ${summary.current.end_date} vs previous
                    </div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">Steps</div>
                            <div class="summary-value">${Math.round(cur.avg_steps).toLocaleString()}</div>
                            <div class="summary-comparison">${renderDiff(calcDiff(cur.avg_steps, prev.avg_steps))}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Distance</div>
                            <div class="summary-value">${cur.total_distance_km.toFixed(1)} km</div>
                            <div class="summary-comparison">${renderDiff(calcDiff(cur.total_distance_km, prev.total_distance_km))}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Active Energy</div>
                            <div class="summary-value">${Math.round(cur.total_active_energy).toLocaleString()} kcal</div>
                            <div class="summary-comparison">${renderDiff(calcDiff(cur.total_active_energy, prev.total_active_energy))}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Workouts</div>
                            <div class="summary-value">${cur.workout_count}</div>
                            <div class="summary-comparison">${renderDiff(calcDiff(cur.workout_count, prev.workout_count))}</div>
                        </div>
                    </div>
                </div>
            `;

            // --- Calendar Grid Section ---
            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const firstDayDow = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay(); // 0 is Sunday

            let gridHtml = `
                <div class="calendar-controls">
                    <button onclick="changeCalendarDate(-1)" class="nav-btn">‚Üê Prev</button>
                    <h3 style="margin:0;">${months[viewDate.getMonth()]} ${viewDate.getFullYear()}</h3>
                    <button onclick="changeCalendarDate(1)" class="nav-btn">Next ‚Üí</button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
            `;

            // Empty cells for days before start of month
            for (let i = 0; i < firstDayDow; i++) {
                gridHtml += '<div class="calendar-cell empty"></div>';
            }

            // Day cells
            // Map grid data by date for easy lookup
            const dayDataMap = {};
            grid.metrics.forEach(m => dayDataMap[m.date] = m);
            // Map workouts by date
            const workoutMap = {};
            grid.workouts.forEach(w => {
                const d = w.start_time.split('T')[0];
                if (!workoutMap[d]) workoutMap[d] = [];
                workoutMap[d].push(w);
            });

            for (let day = 1; day <= daysInMonth; day++) {
                const dateObj = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
                // Adjust for timezone offset to get correct YYYY-MM-DD
                const dateStr = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

                const metric = dayDataMap[dateStr];
                const workouts = workoutMap[dateStr] || [];

                let steps = metric ? metric.steps : 0;
                let intensityClass = 'intensity-0';
                if (steps > 15000) intensityClass = 'intensity-4';
                else if (steps > 10000) intensityClass = 'intensity-3';
                else if (steps > 5000) intensityClass = 'intensity-2';
                else if (steps > 0) intensityClass = 'intensity-1';

                gridHtml += `
                    <div class="calendar-cell ${intensityClass}" title="${dateStr}">
                        <div class="cell-date">${day}</div>
                        ${metric ? `
                            <div class="cell-metric">${metric.steps.toLocaleString()}</div>
                            <div class="cell-metric" style="font-size:0.7em">${metric.sleep_hours.toFixed(1)}h sleep</div>
                        ` : '<div class="cell-metric">-</div>'}
                        ${workouts.length > 0 ? `<div style="margin-top:4px;">${workouts.map(w => `<span class="workout-dot" title="${w.type}: ${w.duration_minutes}m"></span>`).join('')}</div>` : ''}
                    </div>
                `;
            }

            gridHtml += '</div>';

            document.getElementById('content').innerHTML = summaryHtml + gridHtml;
        }

        function renderCorrelations(correlations) {
            if (!correlations || correlations.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="section">
                        <h2>Correlations</h2>
                        <p>Not enough data to compute correlations yet.</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="section">
                    <h2>Metric Correlations</h2>
                    <div class="insight-grid">
                        ${correlations.map(corr => `
                            <div class="insight-card pattern">
                                <div class="insight-title">
                                    ${corr.metric_a.replace(/_/g, ' ')} ‚Üî ${corr.metric_b.replace(/_/g, ' ')}
                                </div>
                                <div class="insight-description">
                                    <strong>${corr.strength}</strong> correlation (r = ${corr.correlation})<br>
                                    ${corr.description}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('content').innerHTML = html;
        }

        function showView(view) {
            currentView = view;

            // Update active button
            document.querySelectorAll('.nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Load appropriate view
            document.getElementById('content').innerHTML = '<div class="loading">Loading...</div>';

            switch (view) {
                case 'overview':
                    loadOverview();
                    break;
                case 'insights':
                    loadInsights();
                    break;
                case 'patterns':
                    loadPatterns();
                    break;
                case 'correlations':
                    loadCorrelations();
                    break;
                case 'calendar':
                    loadCalendar();
                    break;
            }
        }

        // Initial load
        loadOverview();
    </script>
</body>

</html>